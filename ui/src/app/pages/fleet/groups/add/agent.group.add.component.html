<div>
  <header>
    <xng-breadcrumb class="orb-breadcrumb">
    </xng-breadcrumb>
    <h4>{{strings[isEdit ? 'edit' : 'add']['header']}}</h4>
  </header>
  <div class="d-flex row">
    <div class="d-flex col-12 mt-5">
      <nb-stepper *ngIf="!isLoading"
                  class="stepper w-100 ml-5"
                  disableStepNavigation
                  orientation="vertical">
        <nb-step [label]="firstStepTemplate"
                 [stepControl]="firstFormGroup">
          <ng-template #firstStepTemplate>
            <div class="step-label d-flex flex-column">
              <strong>{{strings.add.step.title1}}</strong>
              <p>{{strings.add.step.desc1}}</p>
            </div>
          </ng-template>
          <form (ngSubmit)="onFormSubmit()"
                [formGroup]="firstFormGroup">
            <nb-form-field>
              <div class="d-flex flex-column">
                <div>
                  <label class="font-weight-bold">{{strings.propNames.name}}</label>
                  <span class="required">*</span>
                </div>
                <input autofocus
                       fieldSize="medium"
                       formControlName="name"
                       fullWidth="true"
                       nbInput/>
              </div>
            </nb-form-field>
            <hr/>
            <nb-form-field>
              <div>
                <label class="font-weight-bold">{{strings.propNames.description}}</label>
              </div>
              <input fieldSize="medium"
                     formControlName="description"
                     fullWidth="true"
                     nbInput/>
            </nb-form-field>
            <hr/>
            <div class="d-flex justify-content-end">
              <button (click)="goBack()"
                      data-orb-qa-id="button#cancel"
                      ghost
                      nbButton
                      status="primary"
                      type="button">
                {{ strings.stepper.cancel }}
              </button>
              <button [disabled]="!firstFormGroup.valid"
                      class="next-button"
                      data-orb-qa-id="button#next"
                      nbButton
                      nbStepperNext
                      shape="round"
                      status="primary" type="submit">
                {{ strings.stepper.next }}
              </button>
            </div>
          </form>
        </nb-step>
        <nb-step [label]="secondStepLabel">
          <ng-template #secondStepLabel>
            <div class="step-label d-flex flex-column">
              <strong>{{strings.add.step.title2}}</strong>
              <p>{{strings.add.step.desc2}}</p>
            </div>
          </ng-template>
          <form [formGroup]="secondFormGroup">
            <div class="d-flex">
              <mat-chip-list>
                <mat-chip
                  *ngFor="let tag of selectedTags | keyvalue"
                  [style.background-color]="tag | tagcolor"
                  class="orb-tag-sink ">
                  {{tag | tagchip}}
                  <nb-icon (click)="onRemoveTag(tag.key)"
                           class="ml-1"
                           icon="close-outline"
                           size="12"></nb-icon>
                </mat-chip>
                <mat-chip
                  *ngIf="(selectedTags | json) === '{}'"
                  [style.background-color]="'notag' | tagcolor"
                  class="orb-tag-sink ">
                  No tag added
                </mat-chip>
              </mat-chip-list>
            </div>
            <hr/>
            <nb-form-field>
              <div class="container d-flex row px-0 mx-0">
                <div class="d-flex flex-column col-5 px-0 mx-0">
                  <div>
                    <label class="font-weight-bold">{{strings.propNames.key}}</label>
                    <span class="required">*</span>
                  </div>
                  <div>
                    <input autofocus
                           fieldSize="medium"
                           formControlName="key"
                           fullWidth="true"
                           nbInput/>
                  </div>
                </div>
                <div class="d-flex justify-content-center align-items-center col-1 mt-4 px-0 mx-0">
                  <nb-icon icon="plus-outline" size="14" style="color: #df316f;"></nb-icon>
                </div>
                <div class="d-flex flex-column col-5 px-0 mx-0">
                  <div>
                    <label class="font-weight-bold">{{strings.propNames.value}}</label>
                    <span class="required">*</span>
                  </div>
                  <div>
                    <input autofocus
                           fieldSize="medium"
                           formControlName="value"
                           fullWidth="true"
                           nbInput/>
                  </div>
                </div>
                <div class="d-flex col-1 align-items-center justify-content-center mx-0 pl-4 px-0"
                     style="transform: translateY(14px);">
                  <button (click)="onAddTag()"
                          [disabled]="(secondFormGroup.controls['key'].value === '' ||
                          secondFormGroup.controls['value'].value === '')"
                          ghost
                          nbButton>
                    <nb-icon icon="plus-outline"
                             size="14"
                             status="primary"
                             style="color: #df316f;">
                    </nb-icon>
                  </button>
                </div>
              </div>
            </nb-form-field>
            <hr/>
            <div class="d-flex row">
              <div class="col-12">
                <div>
                  <p *ngIf="tagMatch?.total && tagMatch.total > 0">
                    {{strings.match.matchAny}}&nbsp;{{tagMatch.total}}&nbsp;{{strings.match.agents}}.
                  </p>
                  <p *ngIf="!tagMatch.total || tagMatch.total === 0">
                    {{strings.match.matchNone}}
                  </p>
                </div>
              </div>
            </div>
            <hr/>
            <div *ngIf="secondFormGroup"
                 class="d-flex justify-content-end">
              <button (click)="goBack()"
                      data-orb-qa-id="button#cancel"
                      ghost
                      nbButton
                      status="primary"
                      type="button">
                {{ strings.stepper.cancel }}
              </button>
              <button data-orb-qa-id="button#back"
                      ghost
                      nbButton
                      nbStepperPrevious
                      status="primary">
                {{ strings.stepper.back }}
              </button>
              <button [disabled]="(selectedTags | json) === '{}'"
                      class="next-button"
                      data-orb-qa-id="button#next"
                      nbButton
                      nbStepperNext
                      shape="round"
                      status="primary"
                      type="submit">
                {{ strings.stepper.next }}
              </button>
            </div>
          </form>
        </nb-step>
        <nb-step [label]="thirdStepLabel">
          <ng-template #thirdStepLabel>
            <div class="step-label d-flex flex-column">
              <strong>{{strings.add.step.title3}}</strong>
            </div>
          </ng-template>
          <div *ngIf="!expanded" class="d-flex row">
            <div class="col-md-12 col-xl-6">
              <div>
                <label class="font-weight-bold">{{strings.propNames.name}}</label>
                <p>{{firstFormGroup.controls.name.value}}</p>
              </div>
            </div>
            <hr/>
            <div class="col-md-12 col-xl-6">
              <div>
                <label class="font-weight-bold">{{strings.propNames.description}}</label>
                <p>{{firstFormGroup.controls.description.value}}</p>
              </div>
            </div>
          </div>
          <hr/>
          <div class="d-flex row">
            <div class="col-12">
              <mat-chip-list>
                <mat-chip
                  *ngFor="let tag of selectedTags | keyvalue"
                  [style.background-color]="tag | tagcolor"
                  class="orb-tag-sink ">
                  {{tag | tagchip}}
                </mat-chip>
                <mat-chip
                  *ngIf="(selectedTags | json) === '{}'"
                  [style.background-color]="'notag' | tagcolor"
                  class="orb-tag-sink ">
                  No tag added
                </mat-chip>
              </mat-chip-list>
            </div>
          </div>
          <hr/>
          <div class="d-flex row">
            <div class="col-12">
              <div>
                <p *ngIf="tagMatch?.total && tagMatch.total > 0">
                  {{strings.match.matchAny}}&nbsp;{{tagMatch.total}}&nbsp;{{strings.match.agents}}
                  .&nbsp;<button (click)="toggleExpandMatches()"
                                 class="appearance-ghost size-small status-basic button-expand"
                                 nbButton>{{expanded
                  ? strings.match.collapse
                  : strings.match.expand}}</button>
                </p>
                <p *ngIf="!tagMatch.total || tagMatch.total === 0">
                  {{strings.match.matchNone}}
                </p>
              </div>
            </div>
          </div>
          <hr/>
          <div *ngIf="expanded" class="d-flex row">
            <div class="tag-table">
              <ngx-datatable
                [columnMode]="columnMode.flex"
                [columns]="columns"
                [footerHeight]="50"
                [headerHeight]="50"
                [rowHeight]="50"
                [rows]="matchingAgents"
                [scrollbarV]="true"
                class="orb w-100"
                style="height: 500px;">
              </ngx-datatable>
            </div>
          </div>
          <hr/>
          <div *ngIf="secondFormGroup"
               class="d-flex justify-content-end">
            <button (click)="goBack()"
                    data-orb-qa-id="button#cancel"
                    ghost
                    nbButton
                    status="primary"
                    type="button">
              {{ strings.stepper.cancel }}
            </button>
            <button data-orb-qa-id="button#back"
                    ghost
                    nbButton
                    nbStepperPrevious
                    status="primary">
              {{ strings.stepper.back }}
            </button>
            <button (click)="onFormSubmit()"
                    class="next-button"
                    data-orb-qa-id="button#save"
                    nbButton
                    shape="round"
                    status="primary"
                    type="submit">
              {{ strings.stepper.save }}
            </button>
          </div>
        </nb-step>
      </nb-stepper>
    </div>
  </div>
</div>

<ng-template #agentStateTemplateCell let-i="index" let-row="row" let-value="value">
  <div>
    <div>
      <i class="fa fa-circle orb-service-{{ row.state }}"
         aria-hidden="true"></i>
      {{ row.state | titlecase }}
    </div>
  </div>
</ng-template>

<ng-template #agentTagsTemplateCell let-i="index" let-row="row" let-value="value">
  <div class="d-flex">
    <mat-chip-list>
      <mat-chip
        *ngFor="let tag of value | keyvalue"
        [style.background-color]="tag | tagcolor"
        class="orb-tag-sink ">
        {{tag | tagchip}}
      </mat-chip>
    </mat-chip-list>
  </div>
</ng-template>

<ng-template #agentLastHBTemplateCell let-i="index" let-row="row" let-value="value">
  <div>
    {{ row.ts_last_hb | date: 'medium' }}
  </div>
</ng-template>
